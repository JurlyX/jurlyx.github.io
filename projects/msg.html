<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Discord Clone with Voice</title>
<style>
  body { margin:0; font-family:Arial,sans-serif; display:flex; height:100vh; background:#36393f; color:white; }
  #server-sidebar { width:70px; background:#2f3136; display:flex; flex-direction:column; align-items:center; padding:10px 0; gap:10px; }
  .server { width:50px; height:50px; border-radius:50%; background:#7289da; display:flex; align-items:center; justify-content:center; cursor:pointer; font-weight:bold; }
  .server:hover { filter:brightness(1.2); }
  #channel-sidebar { width:250px; background:#2f3136; padding:10px; display:flex; flex-direction:column; }
  #channel-sidebar h2 { font-size:18px; margin:10px 0; }
  .channel { padding:8px; cursor:pointer; border-radius:4px; }
  .channel:hover { background:#40444b; }
  #main { flex:1; display:flex; flex-direction:column; background:#36393f; }
  #messages { flex:1; padding:10px; overflow-y:auto; }
  #messages div { margin-bottom:10px; }
  #input-area { display:flex; padding:10px; background:#40444b; }
  #input-area input { flex:1; padding:8px; border:none; border-radius:4px; margin-right:10px; }
  #input-area button { padding:8px 12px; border:none; border-radius:4px; background:#7289da; color:white; cursor:pointer; }
  #voice-area { padding:10px; background:#2f3136; display:flex; gap:10px; align-items:center; }
  #voice-area button { background:#43b581; border:none; padding:8px 12px; border-radius:4px; cursor:pointer; color:white; }
</style>
</head>
<body>

<div id="server-sidebar">
  <div class="server" onclick="switchServer('default')">D</div>
</div>

<div id="channel-sidebar">
  <h2 id="server-name">Default Server</h2>
  <div class="channel" onclick="switchChannel('general')"># general</div>
</div>

<div id="main">
  <div id="messages"></div>
  <div id="input-area">
    <input type="text" id="messageInput" placeholder="Type a message...">
    <button onclick="sendMessage()">Send</button>
  </div>
  <div id="voice-area">
    <button onclick="joinVoice()">ðŸŽ¤ Join Voice</button>
    <button onclick="leaveVoice()">â›” Leave Voice</button>
  </div>
</div>

<script>
/*** CONFIG ***/
const JSONBIN_KEY = '$2a$10$w7kHZII5PZ.x1MhtZTBQm.WFZP1ZkfvsbDscb/WNBo9.0kmDtxgH.';
const JSONBIN_BASE = 'https://api.jsonbin.io/v3/b';
const VOICE_BIN = '68f664cdd0ea881f40aec645'; // a dedicated bin for signaling

/*** STATE ***/
let currentServer = 'default';
let currentChannel = 'general';
let messages = [];
let localStream;
let peers = {}; // { userId: RTCPeerConnection }

/*** MESSAGES (same as before) ***/
async function fetchBin(binId) {
  const res = await fetch(`${JSONBIN_BASE}/${binId}/latest`, { headers: { 'X-Master-Key': JSONBIN_KEY } });
  return res.json();
}

async function updateBin(binId, data) {
  const res = await fetch(`${JSONBIN_BASE}/${binId}`, { method:'PUT', headers:{'Content-Type':'application/json','X-Master-Key':JSONBIN_KEY}, body:JSON.stringify(data)});
  return res.json();
}

async function loadMessages() {
  try {
    const data = await fetchBin(currentServer);
    messages = data.record?.[currentChannel] || [];
    renderMessages();
  } catch { messages=[]; renderMessages(); }
}

function renderMessages() {
  const container = document.getElementById('messages');
  container.innerHTML = '';
  messages.forEach(m => { const div = document.createElement('div'); div.textContent = `${m.user}: ${m.text}`; container.appendChild(div); });
  container.scrollTop = container.scrollHeight;
}

async function sendMessage() {
  const input = document.getElementById('messageInput');
  if(!input.value.trim()) return;
  const msg={user:'Me', text:input.value};
  messages.push(msg);
  renderMessages();
  input.value='';
  try{
    const data = await fetchBin(currentServer);
    data.record = data.record || {};
    data.record[currentChannel]=messages;
    await updateBin(currentServer, data.record);
  }catch(e){console.error(e);}
}

function switchChannel(channel){ currentChannel=channel; loadMessages(); }
function switchServer(serverId){ currentServer=serverId; currentChannel='general'; loadMessages(); }

/*** VOICE CHAT ***/
async function joinVoice() {
  if(localStream) return;
  localStream = await navigator.mediaDevices.getUserMedia({ audio:true });

  pollSignals(); // start polling signaling bin
  addMessage('You joined voice chat ðŸŽ¤', 'system');
}

function leaveVoice() {
  if(localStream) {
    localStream.getTracks().forEach(t=>t.stop());
    localStream=null;
    for(let p in peers) peers[p].close();
    peers={};
    addMessage('You left voice chat â›”','system');
  }
}

/*** WEBRTC SIGNALING USING JSONBIN ***/
async function pollSignals() {
  while(localStream){
    try {
      const bin = await fetchBin(VOICE_BIN);
      const signals = bin.record || [];
      for(const s of signals){
        if(s.user==='Me') continue; // skip our own
        if(!peers[s.user]){
          createPeer(s.user, s);
        } else {
          handleSignal(s);
        }
      }
    } catch(e){ console.error(e); }
    await new Promise(r=>setTimeout(r,2000));
  }
}

async function sendSignal(signal){
  const bin = await fetchBin(VOICE_BIN);
  const signals = bin.record || [];
  signals.push(signal);
  await updateBin(VOICE_BIN, signals);
}

function createPeer(userId, signal){
  const pc = new RTCPeerConnection();
  localStream.getTracks().forEach(track=>pc.addTrack(track,localStream));
  pc.ontrack = e=>{
    let audio = document.getElementById('audio_'+userId);
    if(!audio){
      audio=document.createElement('audio');
      audio.id='audio_'+userId;
      audio.autoplay=true;
      document.body.appendChild(audio);
    }
    audio.srcObject=e.streams[0];
  }
  pc.onicecandidate = e=>{
    if(e.candidate) sendSignal({user:'Me', target:userId, candidate:e.candidate});
  }
  peers[userId]=pc;
  pc.setRemoteDescription(new RTCSessionDescription(signal.offer)).then(async()=>{
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    sendSignal({user:'Me', target:userId, answer});
  });
}

async function handleSignal(signal){
  if(signal.target !== 'Me') return;
  const pc = peers[signal.user];
  if(signal.answer) pc.setRemoteDescription(new RTCSessionDescription(signal.answer));
  if(signal.candidate) pc.addIceCandidate(new RTCIceCandidate(signal.candidate));
}

/*** HELPER ***/
function addMessage(text,user='system'){
  const container=document.getElementById('messages');
  const div=document.createElement('div');
  div.textContent=`${user}: ${text}`;
  container.appendChild(div);
  container.scrollTop=container.scrollHeight;
}
</script>

</body>
</html>
