<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Discord Clone â€” High Fidelity (Static + JSONBin)</title>

<!-- Use Inter font (close to Discord) -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#202225; --sidebar:#2f3136; --muted:#72767d; --brand:#5865f2;
    --channel-bg:#2b2f33; --panel:#1f2124; --msg-bg:#2f3336;
    --surface:#2b2f33;
  }
  *{box-sizing:border-box}
  html,body{height:100%; margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial; background:var(--bg); color:#dcddde}
  /* Layout */
  .app{display:flex; height:100vh; width:100vw; overflow:hidden}
  /* Server column */
  .col-servers{width:72px;padding:8px;background:var(--sidebar);display:flex;flex-direction:column;gap:8px;align-items:center;overflow:auto}
  .server-btn{width:48px;height:48px;border-radius:50%;background:#36393f;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;cursor:pointer}
  .server-btn.add{background:var(--brand);font-size:20px}
  .server-btn:hover{filter:brightness(1.15)}
  /* left panel channels */
  .col-channels{width:260px;background:var(--channel-bg);padding:12px;display:flex;flex-direction:column;gap:12px;overflow:auto}
  .server-header{display:flex;justify-content:space-between;align-items:center}
  .server-title{font-weight:700;font-size:16px}
  .server-sub{font-size:12px;color:var(--muted)}
  .channel-section{margin-top:6px}
  .section-title{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:6px}
  .channel-item{padding:6px 8px;border-radius:6px;display:flex;align-items:center;gap:8px;color:#b9bbbe;cursor:pointer}
  .channel-item.active{background:#393c40;color:#fff}
  .channel-item .name{font-weight:500}
  .category{margin-top:8px}
  .cat-title{font-size:12px;color:var(--muted);display:flex;align-items:center;gap:6px}
  .add-channel{margin-top:8px;padding:6px;background:#3a3d41;border-radius:6px;color:#fff;cursor:pointer}
  /* center chat */
  .col-chat{flex:1;display:flex;flex-direction:column;background:linear-gradient(180deg,#2b2f33, #252628)}
  .chat-top{height:64px;background:var(--panel);display:flex;align-items:center;justify-content:space-between;padding:12px 20px;border-bottom:1px solid rgba(0,0,0,0.25)}
  .chat-title{font-weight:700}
  .chat-topic{font-size:12px;color:var(--muted);margin-top:4px}
  .message-area{flex:1;padding:20px;overflow:auto;background:linear-gradient(180deg, rgba(0,0,0,0.02) 0%, transparent 100%)}
  .composer{height:84px;background:var(--panel);display:flex;gap:10px;align-items:center;padding:12px;border-top:1px solid rgba(0,0,0,0.25)}
  .composer .input{flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:#232427;color:#ddd}
  .composer .btn{background:var(--brand);color:white;padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
  /* message */
  .msg-row{display:flex;gap:12px;margin-bottom:12px}
  .avatar{width:44px;height:44px;border-radius:8px;background:#3a3d41;display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff}
  .msg-body{flex:1}
  .msg-header{display:flex;align-items:center;gap:8px}
  .msg-user{font-weight:700}
  .msg-role-badge{font-size:11px;padding:2px 6px;border-radius:8px;margin-left:6px}
  .msg-time{font-size:12px;color:var(--muted);margin-left:6px}
  .msg-text{margin-top:6px;color:#d3d4d6}
  .msg-actions{margin-top:8px;display:flex;gap:8px}
  .msg-action{font-size:13px;color:var(--muted);cursor:pointer;padding:6px;border-radius:6px}
  .msg-action:hover{background:rgba(255,255,255,0.03)}
  /* right panel (DMs + members) */
  .col-right{width:320px;background:var(--surface);padding:12px;display:flex;flex-direction:column;gap:10px}
  .dm-list,.member-list{overflow:auto;max-height:42vh;padding-right:6px}
  .dm-item{display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;cursor:pointer}
  .dm-item:hover{background:#2d2f33}
  .member-row{display:flex;align-items:center;justify-content:space-between;padding:6px;border-radius:6px}
  .role-pill{font-size:12px;padding:2px 6px;border-radius:6px}
  /* modals / drawers */
  .modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#2b2f33;padding:16px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,0.6);z-index:200}
  .hidden{display:none}
  .small{font-size:12px;color:var(--muted)}
  /* notifications & badge */
  .badge{background:#ed4245;color:white;padding:2px 6px;border-radius:999px;font-size:12px}
  /* search results */
  .search-result{padding:8px;border-radius:6px;background:#232425;margin-bottom:6px}
  /* scrollbars */
  ::-webkit-scrollbar{width:10px;height:10px}
  ::-webkit-scrollbar-thumb{background:#383b40;border-radius:6px}
</style>
</head>
<body>
<div class="app">
  <!-- left servers -->
  <div class="col-servers" id="serversCol"></div>

  <!-- channels column -->
  <div class="col-channels">
    <div class="server-header">
      <div>
        <div id="serverName" class="server-title">Server</div>
        <div id="serverMembers" class="server-sub">0 members</div>
      </div>
      <div>
        <button onclick="openServerSettings()" class="small">Server Settings</button>
      </div>
    </div>

    <div id="categoriesContainer" class="channel-section"></div>

    <div class="add-channel" onclick="createChannel()">+ Create Channel</div>
  </div>

  <!-- chat -->
  <div class="col-chat">
    <div class="chat-top">
      <div>
        <div id="channelHeader" class="chat-title">#general</div>
        <div id="channelTopic" class="chat-topic">Topic</div>
      </div>
      <div>
        <input id="quickSearchInput" placeholder="Search messages" class="input" onkeydown="if(event.key==='Enter') quickSearch()" style="padding:8px;border-radius:8px;border:0;background:#232428;color:#ddd"/>
      </div>
    </div>

    <div id="messageArea" class="message-area"></div>

    <div class="composer">
      <button onclick="document.getElementById('fileInput').click()" class="small">ðŸ“Ž</button>
      <input id="fileInput" type="file" class="hidden" onchange="onAttachment(event)"/>
      <input id="messageInput" class="input" placeholder="Message #general" />
      <button class="btn" onclick="sendMessage()">Send</button>
    </div>
  </div>

  <!-- right -->
  <div class="col-right">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>Direct Messages</strong></div>
      <div><button class="small" onclick="openNewDM()">New</button></div>
    </div>
    <div id="dmList" class="dm-list"></div>

    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
      <div><strong>Members</strong></div>
      <div><span class="small" id="onlineCount">0 online</span></div>
    </div>
    <div id="membersList" class="member-list"></div>

    <div style="margin-top:auto">
      <div class="small">Profile</div>
      <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
        <div id="miniAvatar" class="avatar" style="width:44px;height:44px;border-radius:8px"></div>
        <div style="flex:1">
          <input id="profileName" class="input" placeholder="username" />
          <div style="display:flex;gap:6px;margin-top:6px">
            <button class="small" onclick="saveProfile()">Save</button>
            <button class="small" onclick="logout()">Logout</button>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- login modal -->
<div id="loginModal" class="modal" style="width:420px">
  <h2 style="margin:0 0 8px 0">Sign in or Register</h2>
  <input id="loginName" class="input" placeholder="Username" style="width:100%;margin-bottom:8px"/>
  <input id="loginPass" class="input" placeholder="Password" type="password" style="width:100%;margin-bottom:8px"/>
  <div style="display:flex;gap:8px;justify-content:flex-end">
    <button onclick="login()" class="btn">Login</button>
    <button onclick="register()" class="small" style="background:#29a55c;color:white;padding:8px;border-radius:8px">Register</button>
    <button onclick="continueAsGuest()" class="small" style="background:#777;color:white;padding:8px;border-radius:8px">Guest</button>
  </div>
  <div class="small" style="margin-top:8px;color:var(--muted)">Note: this demo stores your JSONBin master key and bins in client code per your request. Not secure for production.</div>
</div>

<!-- server settings drawer -->
<div id="serverSettings" class="modal hidden" style="right:20px;left:auto;top:20px;transform:none;width:480px;height:80vh;overflow:auto">
  <h3>Server Settings</h3>
  <div style="margin-top:8px">
    <label class="small">Name</label>
    <input id="settingsName" class="input" style="width:100%;margin-bottom:8px"/>
    <label class="small">Channels</label>
    <div id="settingsChannels" style="margin-bottom:8px"></div>

    <label class="small">Roles</label>
    <div id="settingsRoles" style="margin-bottom:8px"></div>
    <div style="display:flex;gap:8px">
      <input id="newRoleName" class="input" placeholder="Role name"/>
      <input id="newRoleColor" type="color" value="#57f287"/>
      <button onclick="addRole()" class="small">Add Role</button>
    </div>

    <label class="small" style="margin-top:12px">Members</label>
    <div id="settingsMembers" style="margin-top:6px"></div>

    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button class="small" onclick="saveServerSettings()">Save</button>
      <button class="small" onclick="closeServerSettings()">Close</button>
    </div>
  </div>
</div>

<!-- pinned drawer -->
<div id="pinsModal" class="modal hidden" style="width:520px">
  <h3>Pinned Messages</h3>
  <div id="pinsList" style="max-height:60vh;overflow:auto;margin-top:8px"></div>
  <div style="display:flex;justify-content:flex-end;margin-top:8px">
    <button class="small" onclick="closePins()">Close</button>
  </div>
</div>

<!-- search results -->
<div id="searchModal" class="modal hidden" style="width:640px">
  <h3>Search Results</h3>
  <div id="searchResults" style="max-height:60vh;overflow:auto;margin-top:8px"></div>
  <div style="display:flex;justify-content:flex-end;margin-top:8px"><button class="small" onclick="closeSearch()">Close</button></div>
</div>

<!-- invite modal -->
<div id="inviteModal" class="modal hidden" style="width:420px">
  <h3>Create Invite</h3>
  <div id="inviteCodeBox" class="small" style="margin:8px 0"></div>
  <div style="display:flex;gap:8px;justify-content:flex-end">
    <button class="small" onclick="copyInvite()">Copy</button>
    <button class="small" onclick="closeInvite()">Close</button>
  </div>
</div>

<!-- extensive emoji picker -->
<div id="emojiPicker" class="modal hidden" style="width:420px">
  <h3>Emoji</h3>
  <div style="max-height:50vh;overflow:auto;display:grid;grid-template-columns:repeat(8,1fr);gap:6px;padding-top:8px">
    <script> // emoji cells will be injected dynamically </script>
  </div>
  <div style="display:flex;justify-content:flex-end;margin-top:8px"><button class="small" onclick="closeEmoji()">Close</button></div>
</div>

<input id="hiddenCopy" class="hidden" />

<script>
/*
  High-fidelity Discord-like static app.
  Uses JSONBin as database. Configurable constants below.
  NOTE: This is a client-side demo. Your master key is embedded below as requested.
*/

/* ======================
   CONFIG
   ====================== */
const JSONBIN_KEY = "$2a$10$w7kHZII5PZ.x1MhtZTBQm.WFZP1ZkfvsbDscb/WNBo9.0kmDtxgH."; // you provided
const LOGIN_BIN = "68f665aad0ea881f40aec7bf"; // you provided (accounts)
const SERVERS_BIN = "68f665aad0ea881f40aec700"; // master servers bin used previously
const POLL_MS = 2000; // polling interval

/* ======================
   Helpers for JSONBin v3
   ====================== */
async function jsonbin_get(binId){
  const res = await fetch(`https://api.jsonbin.io/v3/b/${binId}/latest`, { headers: { "X-Master-Key": JSONBIN_KEY }});
  if(!res.ok) throw new Error("Failed GET bin " + binId + " (status " + res.status + ")");
  return res.json();
}
async function jsonbin_put(binId, data){
  const res = await fetch(`https://api.jsonbin.io/v3/b/${binId}`, {
    method: "PUT", headers: { "Content-Type": "application/json", "X-Master-Key": JSONBIN_KEY }, body: JSON.stringify(data)
  });
  if(!res.ok) throw new Error("Failed PUT bin " + binId + " (status " + res.status + ")");
  return res.json();
}

/* ======================
   App state
   ====================== */
let me = null;
let users = []; // from LOGIN_BIN
let servers = {}; // mapping serverId -> server object
let activeServer = null; // server id
let activeChannel = null; // channel name
let pollTimer = null;
let attachments = []; // attachments queued for next message

/* ======================
   Startup
   ====================== */
async function init(){
  // load user accounts (login bin)
  try {
    const ub = await jsonbin_get(LOGIN_BIN);
    users = ub.record || [];
  } catch(e) {
    console.warn("Could not load LOGIN_BIN:", e);
    users = [];
  }

  // load servers
  try {
    const sb = await jsonbin_get(SERVERS_BIN);
    servers = sb.record || {};
    // if no servers, create default
    if(Object.keys(servers).length === 0) await createDefaultServer();
  } catch(e) {
    console.warn("Servers bin missing; bootstrapping default server locally.", e);
    await createDefaultServer();
  }

  // if user not logged in, show modal
  document.getElementById('loginModal').style.display = 'block';

  // populate emoji picker
  buildEmojiPicker();

  // render servers column
  renderServersColumn();
  // set default active server
  activeServer = Object.keys(servers)[0];
  activeChannel = servers[activeServer].channels[0].name || "general";
  renderSidePanels();
  renderChat();
  startPolling();
}

/* create default server and persist */
async function createDefaultServer(){
  const id = "srv_default";
  servers[id] = {
    id, name: "Default Server", icon: null,
    channels: [ { name: "general", topic: "Welcome to general" }, { name: "rules", topic: "Rules & Info" } ],
    voiceChannels: [],
    roles: { "admin": { color: "#ff595e", perms: { all:true } }, "member": { color:"#57f287", perms:{ send:true } } },
    users: {}, messages: { "general": [], "rules": [] }, invites: [], pins: [], audit: []
  };
  // persist
  try { await jsonbin_put(SERVERS_BIN, servers); } catch(e){ console.warn("Failed persist default:", e); }
}

/* ======================
   Auth functions
   ====================== */
async function login(){
  const name = document.getElementById('loginName').value.trim();
  const pass = document.getElementById('loginPass').value;
  if(!name || !pass) return alert("username and password required");
  // reload users to avoid stale
  try { const ub = await jsonbin_get(LOGIN_BIN); users = ub.record || []; } catch(e){ console.warn("users bin get fail", e); }
  const u = users.find(x => x.username === name && x.password === pass);
  if(!u) return alert("Invalid credentials");
  me = u; me.lastActive = Date.now();
  document.getElementById('loginModal').style.display = 'none';
  onLoggedIn();
}
async function register(){
  const name = document.getElementById('loginName').value.trim();
  const pass = document.getElementById('loginPass').value;
  if(!name || !pass) return alert("username and password required");
  try { const ub = await jsonbin_get(LOGIN_BIN); users = ub.record || []; } catch(e){ users = []; }
  if(users.some(x=>x.username === name)) return alert("Username exists");
  const profile = { username: name, password: pass, avatar: null, bio: "", status: "online", createdAt: Date.now() };
  users.push(profile);
  try { await jsonbin_put(LOGIN_BIN, users); } catch(e){ console.error("Failed saving users", e); }
  me = profile;
  document.getElementById('loginModal').style.display = 'none';
  onLoggedIn();
}
function continueAsGuest(){
  me = { username: "Guest"+Math.floor(Math.random()*9000+1000), avatar:null, status:"online" };
  document.getElementById('loginModal').style.display = 'none';
  onLoggedIn();
}
async function saveProfile(){
  const name = document.getElementById('profileName').value.trim();
  if(!name) return alert("Enter a name");
  me.username = name;
  // write back if user exists in users list
  const idx = users.findIndex(u=>u.username === name);
  if(idx >= 0){
    users[idx] = { ...users[idx], ...me };
    try { await jsonbin_put(LOGIN_BIN, users); } catch(e){ console.warn("Failed update users bin", e); }
  }
  renderSidePanels();
}
function logout(){
  if(!confirm("Logout?")) return;
  me = null;
  document.getElementById('loginModal').style.display = 'block';
}

/* ======================
   UI Render helpers
   ====================== */
function renderServersColumn(){
  const col = document.getElementById('serversCol');
  col.innerHTML = "";
  Object.keys(servers).forEach(sid=>{
    const s = servers[sid];
    const btn = document.createElement('div');
    btn.className = "server-btn";
    btn.title = s.name;
    btn.innerText = (s.name && s.name[0]) || "S";
    btn.onclick = ()=> { activeServer = sid; activeChannel = s.channels[0].name; renderSidePanels(); renderChat(); };
    col.appendChild(btn);
  });
  const add = document.createElement('div');
  add.className = "server-btn add";
  add.innerText = "+";
  add.title = "Create Server";
  add.onclick = ()=> createServerPrompt();
  col.appendChild(add);
}

function renderSidePanels(){
  if(!activeServer) return;
  // server header
  const srv = servers[activeServer];
  document.getElementById('serverName').innerText = srv.name;
  document.getElementById('serverMembers').innerText = (Object.keys(srv.users || {}).length) + " members";

  // left: categories & channels
  const catContainer = document.getElementById('categoriesContainer');
  catContainer.innerHTML = "";
  // We'll render channel categories as a single category "Text Channels"
  const textCat = document.createElement('div');
  textCat.className = "category";
  const title = document.createElement('div');
  title.className = "cat-title section-title";
  title.innerText = "Text Channels";
  textCat.appendChild(title);
  srv.channels.forEach(ch => {
    const chEl = document.createElement('div');
    chEl.className = "channel-item " + (activeChannel === ch.name ? "active":"");
    chEl.innerHTML = `<div class="name"># ${ch.name}</div><div style="margin-left:auto" class="small">${(srv.messages[ch.name]||[]).filter(m=>!m.deleted).length}</div>`;
    chEl.onclick = ()=> { activeChannel = ch.name; renderChat(); renderSidePanels(); };
    textCat.appendChild(chEl);
  });
  catContainer.appendChild(textCat);

  // voice channels
  const voiceCat = document.createElement('div');
  voiceCat.className = "category";
  const vtitle = document.createElement('div');
  vtitle.className = "cat-title section-title";
  vtitle.innerText = "Voice Channels";
  voiceCat.appendChild(vtitle);
  (srv.voiceChannels||[]).forEach(vc=>{
    const vcEl = document.createElement('div'); vcEl.className = "channel-item";
    vcEl.innerText = "ðŸ”Š " + vc.name;
    voiceCat.appendChild(vcEl);
  });
  catContainer.appendChild(voiceCat);

  // right: members
  renderMembers();
  renderDMs();
  // profile mini
  document.getElementById('miniAvatar').innerText = me.username? me.username[0] : '?';
  document.getElementById('profileName').value = me.username || '';
}

function renderMembers(){
  const out = document.getElementById('membersList');
  out.innerHTML = "";
  const srv = servers[activeServer];
  if(!srv) return;
  const names = Object.keys(srv.users || {});
  names.forEach(un=>{
    const role = srv.users[un];
    const roleColor = (srv.roles && srv.roles[role] && srv.roles[role].color) || "#999";
    const row = document.createElement('div');
    row.className = "member-row";
    const left = document.createElement('div'); left.style.display="flex"; left.style.alignItems="center"; left.style.gap="8px";
    const avatar = document.createElement('div'); avatar.className='avatar'; avatar.style.width='36px'; avatar.style.height='36px'; avatar.innerText = un[0];
    const txt = document.createElement('div'); txt.innerHTML = `<div style="font-weight:600;color:${roleColor}">${un}</div><div style="font-size:12px;color:var(--muted)">${role||'member'}</div>`;
    left.appendChild(avatar); left.appendChild(txt);
    const right = document.createElement('div');
    const dmBtn = document.createElement('button'); dmBtn.className='small'; dmBtn.innerText='Message'; dmBtn.onclick = ()=> openDM([me.username, un]);
    right.appendChild(dmBtn);
    row.appendChild(left); row.appendChild(right);
    out.appendChild(row);
  });
}

/* DM list (servers starting with DM_) */
function renderDMs(){
  const out = document.getElementById('dmList');
  out.innerHTML = "";
  Object.keys(servers).forEach(sid=>{
    if(!sid.startsWith('DM_')) return;
    const s = servers[sid];
    if(!s.users || !s.users[me.username]) return; // only show DMs the user is in
    const item = document.createElement('div'); item.className="dm-item";
    item.onclick = ()=> { activeServer = sid; activeChannel = s.channels[0].name; renderSidePanels(); renderChat(); };
    const left = document.createElement('div'); left.style.display='flex'; left.style.gap='8px'; left.style.alignItems='center';
    const avatar = document.createElement('div'); avatar.className='avatar'; avatar.style.width='36px'; avatar.style.height='36px'; avatar.innerText = s.name[0]||'D';
    left.appendChild(avatar); left.appendChild(document.createElement('div')).innerHTML=`<div style="font-weight:600">${s.name}</div>`;
    item.appendChild(left);
    out.appendChild(item);
  });
}

/* render chat messages for active server/channel */
function renderChat(){
  const area = document.getElementById('messageArea');
  area.innerHTML = "";
  const srv = servers[activeServer];
  if(!srv) return;
  document.getElementById('channelHeader').innerText = "#" + activeChannel;
  document.getElementById('channelTopic').innerText = (srv.channels.find(c=>c.name===activeChannel) || {}).topic || "";

  const msgs = (srv.messages && srv.messages[activeChannel]) || [];
  msgs.forEach(m => {
    if(m.deleted) return;
    const row = document.createElement('div'); row.className='msg-row';
    const av = document.createElement('div'); av.className='avatar'; av.innerText = (m.user && m.user[0]) || '?';
    const body = document.createElement('div'); body.className='msg-body';
    const header = document.createElement('div'); header.className='msg-header';
    const username = document.createElement('div'); username.className='msg-user'; username.innerText = m.user;
    // role color
    const roleName = (srv.users && srv.users[m.user]) || null;
    if(roleName){
      const pill = document.createElement('span'); pill.className='msg-role-badge'; pill.innerText = roleName;
      pill.style.background = (srv.roles && srv.roles[roleName] && srv.roles[roleName].color) || '#666';
      header.appendChild(pill);
    }
    const timeEl = document.createElement('div'); timeEl.className='msg-time'; timeEl.innerText = new Date(m.time).toLocaleString();
    header.appendChild(username); header.appendChild(timeEl);
    body.appendChild(header);
    const text = document.createElement('div'); text.className='msg-text'; text.innerHTML = formatText(m.text || "");
    body.appendChild(text);

    // attachments
    if(m.attachments && m.attachments.length){
      m.attachments.forEach(att=>{
        if(att.type && att.type.startsWith('image/')){
          const img = document.createElement('img'); img.src = att.dataUrl; img.style.maxWidth='360px'; img.style.marginTop='8px'; img.style.borderRadius='8px';
          body.appendChild(img);
        } else {
          const a = document.createElement('a'); a.href = att.dataUrl; a.target='_blank'; a.innerText = "ðŸ“Ž " + att.name; a.className='small'; a.style.display='block'; a.style.marginTop='8px';
          body.appendChild(a);
        }
      });
    }

    // reactions
    const reactBar = document.createElement('div'); reactBar.className='msg-actions';
    (m.reactions || []).forEach(r=>{
      const btn = document.createElement('div'); btn.className='msg-action'; btn.innerText = `${r.emoji} ${r.users.length}`;
      btn.onclick = ()=> toggleReaction(m.id, r.emoji);
      reactBar.appendChild(btn);
    });
    // add react
    const addR = document.createElement('div'); addR.className='msg-action'; addR.innerText='+';
    addR.onclick = ()=> { const em = prompt("Emoji to react with"); if(em) toggleReaction(m.id, em); };
    reactBar.appendChild(addR);

    // actions: edit/delete/pin/copy
    const editBtn = document.createElement('div'); editBtn.className='msg-action'; editBtn.innerText='Edit';
    editBtn.onclick = ()=> editMessage(m.id);
    const delBtn = document.createElement('div'); delBtn.className='msg-action'; delBtn.innerText='Delete';
    delBtn.onclick = ()=> deleteMessage(m.id);
    const pinBtn = document.createElement('div'); pinBtn.className='msg-action'; pinBtn.innerText='Pin';
    pinBtn.onclick = ()=> pinMessage(m.id);
    const copyBtn = document.createElement('div'); copyBtn.className='msg-action'; copyBtn.innerText='Copy';
    copyBtn.onclick = ()=> { navigator.clipboard.writeText(m.text || ""); alert("Copied"); };

    reactBar.appendChild(editBtn); reactBar.appendChild(delBtn); reactBar.appendChild(pinBtn); reactBar.appendChild(copyBtn);
    body.appendChild(reactBar);

    row.appendChild(av); row.appendChild(body);
    area.appendChild(row);
  });

  // scroll bottom
  area.scrollTop = area.scrollHeight;
}

/* ======================
   Text formatting & mentions
   ====================== */
function formatText(t){
  if(!t) return "";
  // escape
  let s = t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  // bold/italic/code
  s = s.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
  s = s.replace(/\*(.+?)\*/g,'<em>$1</em>');
  s = s.replace(/`(.+?)`/g,'<code>$1</code>');
  // mentions
  s = s.replace(/@([a-zA-Z0-9_]+)/g, (m, uname) => {
    // highlight if present in server
    const srv = servers[activeServer];
    if(srv && srv.users && srv.users[uname]) return `<span style="background:#3a3f44;padding:2px 6px;border-radius:6px">@${uname}</span>`;
    return `@${uname}`;
  });
  return s;
}

/* ======================
   Message actions: send/edit/delete/pin/reactions
   ====================== */
async function sendMessage(){
  const input = document.getElementById('messageInput');
  const text = input.value.trim();
  if(!text && attachments.length===0) return;
  const srv = servers[activeServer];
  if(!srv) return alert("No server");
  const ch = activeChannel;
  const msg = {
    id: "m_"+Date.now()+"_"+Math.random().toString(36, 4).slice(2),
    user: me.username,
    text,
    attachments: attachments,
    reactions: [], // array of {emoji, users:[]}
    time: Date.now(), edited:false, deleted:false
  };
  srv.messages[ch] = srv.messages[ch] || [];
  srv.messages[ch].push(msg);
  // audit log
  srv.audit = srv.audit || [];
  srv.audit.push({ action: 'message_create', user: me.username, target: ch, time: Date.now(), id: msg.id });
  // save
  try { await jsonbin_put(SERVERS_BIN, servers); } catch(e){ console.error("save fail", e); }
  attachments = [];
  input.value = "";
  renderChat();
}

async function editMessage(mid){
  const srv = servers[activeServer];
  const ch = activeChannel;
  const m = (srv.messages[ch] || []).find(x=>x.id===mid);
  if(!m) return alert("Message not found");
  if(m.user !== me.username) return alert("You can only edit your own messages");
  const txt = prompt("Edit message", m.text);
  if(txt === null) return;
  m.text = txt; m.edited = true; m.editedAt = Date.now();
  srv.audit = srv.audit || []; srv.audit.push({action:'message_edit', user:me.username, id:mid, time:Date.now()});
  try { await jsonbin_put(SERVERS_BIN, servers); } catch(e){ console.error("edit save fail", e); }
  renderChat();
}

async function deleteMessage(mid){
  const srv = servers[activeServer];
  const ch = activeChannel;
  const m = (srv.messages[ch] || []).find(x=>x.id===mid);
  if(!m) return;
  // permission: author or admin
  const myRole = srv.users[me.username];
  const isAdmin = srv.roles && srv.roles[myRole] && srv.roles[myRole].perms && srv.roles[myRole].perms.all;
  if(m.user !== me.username && !isAdmin) return alert("No permission");
  if(!confirm("Delete message?")) return;
  m.deleted = true;
  srv.audit = srv.audit || []; srv.audit.push({action:'message_delete', user:me.username, id:mid, time:Date.now()});
  try { await jsonbin_put(SERVERS_BIN, servers); } catch(e){ console.error("del save fail", e); }
  renderChat();
}

async function pinMessage(mid){
  const srv = servers[activeServer];
  srv.pins = srv.pins || [];
  if(!srv.pins.includes(mid)) srv.pins.push(mid);
  srv.audit = srv.audit || []; srv.audit.push({action:'pin', user:me.username, id:mid, time:Date.now()});
  try { await jsonbin_put(SERVERS_BIN, servers); } catch(e){ console.error("pin fail", e); }
  openPins();
}

async function toggleReaction(mid, emoji){
  const srv = servers[activeServer];
  const ch = activeChannel;
  const m = (srv.messages[ch]||[]).find(x=>x.id===mid);
  if(!m) return;
  m.reactions = m.reactions || [];
  let r = m.reactions.find(r=>r.emoji === emoji);
  if(!r){ r = { emoji, users: [] }; m.reactions.push(r); }
  const idx = r.users.indexOf(me.username);
  if(idx >= 0) r.users.splice(idx,1);
  else r.users.push(me.username);
  try{ await jsonbin_put(SERVERS_BIN, servers); } catch(e){ console.error("react save fail", e); }
  renderChat();
}

/* attachments */
function onAttachment(e){
  const file = e.target.files[0];
  if(!file) return;
  const fr = new FileReader();
  fr.onload = function(evt){
    attachments.push({ name: file.name, size: file.size, type: file.type, dataUrl: evt.target.result });
    alert("Attachment queued: " + file.name);
  };
  fr.readAsDataURL(file);
}

/* ======================
   Channel & server management
   ====================== */
async function createChannel(){
  const name = prompt("Channel name (no #):");
  if(!name) return;
  const srv = servers[activeServer];
  srv.channels.push({ name, topic: "" });
  srv.messages[name] = [];
  srv.audit = srv.audit || []; srv.audit.push({action:'channel_create', user:me.username, channel:name, time:Date.now()});
  try{ await jsonbin_put(SERVERS_BIN, servers); } catch(e){ console.error("create channel save fail", e); }
  renderSidePanels(); renderChat();
}

async function createServerPrompt(){
  const name = prompt("Server name:");
  if(!name) return;
  const id = "srv_"+Date.now()+"_"+Math.random().toString(36).slice(2,6);
  servers[id] = { id, name, icon:null, channels:[{name:"general",topic:""}], voiceChannels:[], roles:{ "owner":{color:"#ffb86b", perms:{all:true}}, "member":{color:"#57f287", perms:{send:true}} }, users:{ [me.username]:"owner" }, messages:{ "general": [] }, invites:[], pins:[], audit:[] };
  try{ await jsonbin_put(SERVERS_BIN, servers); } catch(e){ console.error("create server save fail", e); }
  activeServer = id; activeChannel = "general";
  renderServersColumn(); renderSidePanels(); renderChat();
}

/* Server settings */
function openServerSettings(){
  const modal = document.getElementById('serverSettings');
  modal.classList.remove('hidden');
  modal.style.display = 'block';
  const srv = servers[activeServer];
  document.getElementById('settingsName').value = srv.name;
  renderSettingsChannels();
  renderSettingsRoles();
  renderSettingsMembers();
}
function closeServerSettings(){ const m = document.getElementById('serverSettings'); m.classList.add('hidden'); m.style.display='none'; }
function renderSettingsChannels(){
  const cont = document.getElementById('settingsChannels'); cont.innerHTML = "";
  const srv = servers[activeServer];
  srv.channels.forEach(ch=>{
    const d = document.createElement('div'); d.innerHTML = `<strong># ${ch.name}</strong> - <span class="small">${ch.topic||''}</span>`;
    cont.appendChild(d);
  });
}
function renderSettingsRoles(){
  const cont = document.getElementById('settingsRoles'); cont.innerHTML = "";
  const srv = servers[activeServer];
  Object.keys(srv.roles || {}).forEach(rn=>{
    const role = srv.roles[rn];
    const div = document.createElement('div'); div.style.display='flex'; div.style.gap='8px'; div.style.alignItems='center'; div.style.marginBottom='6px';
    const nameInput = document.createElement('input'); nameInput.value = rn; nameInput.className='input'; nameInput.style.width='160px';
    const colorInput = document.createElement('input'); colorInput.type='color'; colorInput.value = role.color || '#888';
    const del = document.createElement('button'); del.className='small'; del.innerText='Delete'; del.onclick = ()=> { delete srv.roles[rn]; renderSettingsRoles(); renderSidePanels(); };
    div.appendChild(nameInput); div.appendChild(colorInput); div.appendChild(del);
    cont.appendChild(div);
    // wire rename on blur
    nameInput.onblur = ()=> {
      const newn = nameInput.value.trim(); if(!newn || newn === rn) return;
      srv.roles[newn] = srv.roles[rn]; delete srv.roles[rn];
      // remap users
      Object.keys(srv.users).forEach(u=>{ if(srv.users[u] === rn) srv.users[u] = newn; });
      renderSettingsRoles(); renderSettingsMembers(); renderSidePanels();
    };
    colorInput.onchange = ()=> { srv.roles[rn].color = colorInput.value; renderSidePanels(); }
  });
}
function renderSettingsMembers(){
  const cont = document.getElementById('settingsMembers'); cont.innerHTML = "";
  const srv = servers[activeServer];
  Object.keys(srv.users || {}).forEach(un=>{
    const row = document.createElement('div'); row.style.display='flex'; row.style.gap='8px'; row.style.alignItems='center'; row.style.marginBottom='6px';
    const name = document.createElement('div'); name.innerText = un; name.style.flex='1';
    const sel = document.createElement('select'); sel.className='input';
    Object.keys(srv.roles || {}).forEach(rn=> { const o = document.createElement('option'); o.value=rn; o.innerText = rn; if(srv.users[un]===rn) o.selected=true; sel.appendChild(o); });
    sel.onchange = ()=> { srv.users[un] = sel.value; renderMembers(); };
    row.appendChild(name); row.appendChild(sel);
    cont.appendChild(row);
  });
}
async function addRole(){
  const name = document.getElementById('newRoleName').value.trim();
  const color = document.getElementById('newRoleColor').value;
  if(!name) return alert("role name required");
  const srv = servers[activeServer];
  srv.roles[name] = { color, perms: { send:true } };
  document.getElementById('newRoleName').value = '';
  renderSettingsRoles();
}
async function saveServerSettings(){
  const srv = servers[activeServer];
  srv.name = document.getElementById('settingsName').value.trim();
  try{ await jsonbin_put(SERVERS_BIN, servers); } catch(e){ console.error("save server settings failed", e); }
  closeServerSettings();
  renderServersColumn(); renderSidePanels(); renderChat();
}

/* ======================
   Invites
   ====================== */
async function createInvite(){
  const code = "INV_" + Math.random().toString(36).slice(2,8).toUpperCase();
  const srv = servers[activeServer];
  srv.invites = srv.invites || []; srv.invites.push({ code, createdBy: me.username, createdAt: Date.now() });
  try{ await jsonbin_put(SERVERS_BIN, servers); } catch(e){ console.warn("invite save fail", e); }
  document.getElementById('inviteCodeBox').innerText = code;
  document.getElementById('inviteModal').classList.remove('hidden');
}
function copyInvite(){
  const t = document.getElementById('inviteCodeBox').innerText; navigator.clipboard.writeText(t).then(()=>alert("Copied"));
}
function closeInvite(){ document.getElementById('inviteModal').classList.add('hidden'); }
async function acceptInvite(code){
  // find server
  for(const sid in servers){
    if((servers[sid].invites||[]).find(i=>i.code === code)){
      servers[sid].users = servers[sid].users || {}; servers[sid].users[me.username] = "member";
      try{ await jsonbin_put(SERVERS_BIN, servers); } catch(e){ console.warn("accept invite save fail", e); }
      activeServer = sid; activeChannel = servers[sid].channels[0].name;
      renderServersColumn(); renderSidePanels(); renderChat(); return alert("Joined");
    }
  }
  alert("Invite not found");
}

/* UI helpers for pins/search */
function openPins(){
  const m = document.getElementById('pinsModal'); m.classList.remove('hidden'); m.style.display='block';
  const out = document.getElementById('pinsList'); out.innerHTML='';
  const srv = servers[activeServer];
  (srv.pins||[]).forEach(id=>{
    const msg = Object.values(srv.messages).flat().find(x=>x.id === id);
    if(!msg) return;
    const div = document.createElement('div'); div.className='search-result'; div.innerHTML = `<strong>${msg.user}</strong><div class="small">${msg.text}</div>`;
    out.appendChild(div);
  });
}
function closePins(){ const m=document.getElementById('pinsModal'); m.classList.add('hidden'); m.style.display='none'; }

function quickSearch(){
  const term = document.getElementById('quickSearchInput').value.trim();
  if(!term) return alert("enter search term");
  const srv = servers[activeServer];
  const results = [];
  Object.keys(srv.messages || {}).forEach(ch=>{
    (srv.messages[ch] || []).forEach(m=>{
      if(m.text && m.text.toLowerCase().includes(term.toLowerCase())) results.push({ ch, m });
    });
  });
  // show modal
  const m = document.getElementById('searchModal'); m.classList.remove('hidden'); m.style.display='block';
  const out = document.getElementById('searchResults'); out.innerHTML='';
  results.slice(0,200).forEach(r=>{
    const div = document.createElement('div'); div.className='search-result';
    div.innerHTML = `<div><strong>#${r.ch} â€” ${r.m.user}</strong> <div class="small">${new Date(r.m.time).toLocaleString()}</div></div><div class="small">${r.m.text}</div>`;
    out.appendChild(div);
  });
}
function closeSearch(){ document.getElementById('searchModal').classList.add('hidden'); document.getElementById('searchModal').style.display='none'; }

/* ======================
   DMs
   ====================== */
async function openNewDM(){
  const name = prompt("Enter username or comma list for group DM");
  if(!name) return;
  const names = name.split(',').map(x=>x.trim()).filter(Boolean);
  names.push(me.username);
  const id = "DM_"+ names.slice().sort().join("_");
  if(!servers[id]){
    servers[id] = { id, name: names.filter(n=>n!==me.username).join(", "), channels:[{name:"general"}], users:{}, roles:{ member:{ color:"#57f287", perms:{ send:true } } }, messages:{ general:[] }, invites:[], pins:[], audit:[] };
    names.forEach(n => servers[id].users[n] = "member");
    await jsonbin_put(SERVERS_BIN, servers);
  }
  activeServer = id; activeChannel = "general"; renderSidePanels(); renderChat();
}
function openDM(names){
  const arr = Array.isArray(names) ? names : [names];
  arr.push(me.username);
  const id = "DM_"+ arr.slice().sort().join("_");
  if(!servers[id]) openNewDM(); else { activeServer = id; activeChannel = "general"; renderSidePanels(); renderChat(); }
}

/* ======================
   Realtime polling
   ====================== */
function startPolling(){
  if(pollTimer) clearInterval(pollTimer);
  pollTimer = setInterval(async ()=>{
    try {
      const ub = await jsonbin_get(LOGIN_BIN); users = ub.record || users;
    } catch(e){ /* ignore */ }
    try {
      const sb = await jsonbin_get(SERVERS_BIN);
      servers = sb.record || servers;
      if(!activeServer) activeServer = Object.keys(servers)[0];
      // ensure active channel exists
      if(activeServer && servers[activeServer] && !servers[activeServer].channels.find(c=>c.name === activeChannel)){
        activeChannel = servers[activeServer].channels[0]?.name || null;
      }
      renderServersColumn(); renderSidePanels(); renderChat();
    } catch(e){
      console.warn("poll fail", e);
    }
  }, POLL_MS);
}

/* ======================
   Emoji picker
   ====================== */
function buildEmojiPicker(){
  const emojis = ["ðŸ˜€","ðŸ˜ƒ","ðŸ˜„","ðŸ˜","ðŸ˜†","ðŸ˜…","ðŸ˜‚","ðŸ¤£","ðŸ™‚","ðŸ™ƒ","ðŸ˜‰","ðŸ˜Š","ðŸ˜","ðŸ˜˜","ðŸ˜œ","ðŸ¤ª","ðŸ¤©","ðŸ˜Ž","ðŸ¤”","ðŸ¤¨","ðŸ˜","ðŸ˜¶","ðŸ™„","ðŸ˜","ðŸ˜´","ðŸ˜­","ðŸ˜¢","ðŸ˜¤","ðŸ˜¡","ðŸ‘","ðŸ‘Ž","ðŸ™","ðŸ‘","ðŸ™Œ","ðŸ”¥","âœ¨","ðŸŽ‰","ðŸ’¯"];
  const container = document.getElementById('emojiPicker').querySelector('div');
  emojis.forEach(e=>{
    const b = document.createElement('button'); b.className='small'; b.style.padding='6px'; b.innerText = e;
    b.onclick = ()=> { document.getElementById('messageInput').value += e; closeEmoji(); };
    container.appendChild(b);
  });
}
function closeEmoji(){ document.getElementById('emojiPicker').classList.add('hidden'); document.getElementById('emojiPicker').style.display='none'; }

/* ======================
   Utility & bootstrap
   ====================== */
function onLoggedIn(){
  renderSidePanels();
  renderChat();
  // welcome message
  try { if(me && me.username) alert("Welcome " + me.username); } catch(e){}
  // ensure user is in default server if not present
  if(!servers[activeServer].users[me.username]){
    servers[activeServer].users[me.username] = "member";
    jsonbin_put(SERVERS_BIN, servers).catch(()=>{});
  }
}
window.addEventListener('load', ()=> init());

</script>
</body>
</html>
