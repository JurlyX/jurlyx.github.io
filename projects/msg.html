<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Discord Clone Multiuser</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  ::-webkit-scrollbar { width: 8px; }
  ::-webkit-scrollbar-thumb { background-color: #555; border-radius: 4px; }
</style>
</head>
<body class="bg-gray-800 text-white h-screen flex">

<!-- Sidebar: Servers -->
<div id="server-sidebar" class="flex flex-col w-20 bg-gray-900 p-2 gap-2 overflow-y-auto"></div>

<!-- Channel Sidebar -->
<div class="flex flex-col w-64 bg-gray-900 p-4" id="channel-sidebar">
  <h2 id="server-name" class="text-lg font-bold mb-4">Default Server</h2>
  <div id="channel-list" class="flex flex-col gap-2"></div>
  <button onclick="createChannel()" class="mt-4 px-2 py-1 bg-blue-600 rounded hover:bg-blue-500">+ Add Channel</button>
</div>

<!-- Main Chat -->
<div class="flex-1 flex flex-col">
  <div id="messages" class="flex-1 p-4 overflow-y-auto space-y-2"></div>
  <div class="flex p-4 bg-gray-700">
    <input id="messageInput" type="text" class="flex-1 rounded px-2 py-1 bg-gray-600 focus:outline-none" placeholder="Type a message...">
    <button onclick="sendMessage()" class="ml-2 px-4 py-1 bg-blue-600 rounded hover:bg-blue-500">Send</button>
  </div>
</div>

<!-- DM Sidebar -->
<div id="dm-panel" class="w-64 bg-gray-900 p-4 flex flex-col">
  <h2 class="text-lg font-bold mb-4">Direct Messages</h2>
  <div id="dm-users" class="flex flex-col gap-2 overflow-y-auto"></div>
</div>

<!-- Login Overlay -->
<div id="login" class="absolute inset-0 bg-gray-900 flex flex-col items-center justify-center gap-4">
  <h1 class="text-2xl font-bold">Login / Register</h1>
  <input id="loginUser" type="text" placeholder="Username" class="px-2 py-1 rounded bg-gray-700 focus:outline-none">
  <input id="loginPass" type="password" placeholder="Password" class="px-2 py-1 rounded bg-gray-700 focus:outline-none">
  <div class="flex gap-2">
    <button onclick="login()" class="px-4 py-1 bg-blue-600 rounded hover:bg-blue-500">Login</button>
    <button onclick="register()" class="px-4 py-1 bg-green-600 rounded hover:bg-green-500">Register</button>
  </div>
</div>

<script>
/*** CONFIG ***/
const JSONBIN_KEY="$2a$10$w7kHZII5PZ.x1MhtZTBQm.WFZP1ZkfvsbDscb/WNBo9.0kmDtxgH.";
const LOGIN_BIN="68f665aad0ea881f40aec7bf"; // user accounts
const SERVER_BIN="68f665aad0ea881f40aec700"; // master bin for servers data
let currentUser="", currentServer="default", currentChannel="general";

/*** UTILS ***/
async function fetchBin(binId){ const res=await fetch(`https://api.jsonbin.io/v3/b/${binId}/latest`, { headers:{'X-Master-Key':JSONBIN_KEY}}); return res.json(); }
async function updateBin(binId,data){ await fetch(`https://api.jsonbin.io/v3/b/${binId}`,{method:'PUT', headers:{'Content-Type':'application/json','X-Master-Key':JSONBIN_KEY}, body:JSON.stringify(data)}); }

/*** STATE ***/
let users=[], servers={default:{name:"Default Server",channels:["general"],roles:{admin:{color:"red",perm:["all"]}},users:{}}}, messages={} ;

/*** LOGIN ***/
async function loadUsersBin(){ try{ const bin=await fetchBin(LOGIN_BIN); users=bin.record||[]; }catch{ users=[]; } }
async function saveUsersBin(){ await updateBin(LOGIN_BIN,users); }
async function login(){
  await loadUsersBin(); const u=document.getElementById('loginUser').value.trim(); const p=document.getElementById('loginPass').value;
  const found=users.find(x=>x.username===u && x.password===p);
  if(found){ currentUser=u; document.getElementById('login').style.display='none'; loadServers(); loadUI(); startPolling(); }
  else alert('Invalid login');
}
async function register(){
  await loadUsersBin(); const u=document.getElementById('loginUser').value.trim(); const p=document.getElementById('loginPass').value;
  if(users.find(x=>x.username===u)){ alert('Username exists'); return; }
  users.push({username:u,password:p,dms:[],servers:["default"]}); currentUser=u; await saveUsersBin(); document.getElementById('login').style.display='none';
  loadServers(); loadUI(); startPolling();
}

/*** SERVERS / CHANNELS ***/
async function loadServers(){
  try{ const bin=await fetchBin(SERVER_BIN); servers=bin.record||servers; messages={} ; for(let s in servers){ messages[s]={}; servers[s].channels.forEach(c=>messages[s][c]=[]); } } catch(e){ console.error(e); }
}
async function saveServers(){ await updateBin(SERVER_BIN,servers); }

function renderServers(){
  const sidebar=document.getElementById('server-sidebar'); sidebar.innerHTML='';
  Object.keys(servers).forEach(s=>{
    const div=document.createElement('div'); div.className='server bg-gray-600 flex items-center justify-center rounded text-lg cursor-pointer'; div.textContent=servers[s].name[0];
    div.onclick=()=>switchServer(s); sidebar.appendChild(div);
  });
  const addBtn=document.createElement('div'); addBtn.className='server bg-green-600 flex items-center justify-center rounded text-lg cursor-pointer'; addBtn.textContent="+";
  addBtn.onclick=createServer; sidebar.appendChild(addBtn);
}
function renderChannels(){
  const list=document.getElementById('channel-list'); list.innerHTML='';
  servers[currentServer].channels.forEach(c=>{
    const div=document.createElement('div'); div.className='channel'; div.textContent='# '+c; div.onclick=()=>switchChannel(c);
    list.appendChild(div);
  });
}
function createServer(){
  const name=prompt("Server Name?"); if(!name) return;
  const id="S"+Date.now();
  servers[id]={name,channels:["general"],roles:{admin:{color:"red",perm:["all"]}},users:{[currentUser]:"admin"}};
  saveServers(); renderServers(); switchServer(id);
}
function createChannel(){
  const name=prompt("Channel Name?"); if(!name) return;
  servers[currentServer].channels.push(name); messages[currentServer][name]=[]; saveServers(); renderChannels();
}
function switchServer(id){ currentServer=id; currentChannel=servers[id].channels[0]; document.getElementById('server-name').textContent=servers[id].name; renderChannels(); renderMessages(); }

/*** MESSAGES ***/
function renderMessages(){
  const container=document.getElementById('messages'); container.innerHTML='';
  if(!messages[currentServer][currentChannel]) messages[currentServer][currentChannel]=[];
  messages[currentServer][currentChannel].forEach(m=>{
    const time=new Date(m.time).toLocaleTimeString();
    const color=servers[currentServer].users[m.user]?servers[currentServer].roles[servers[currentServer].users[m.user]]?.color||"white":"white";
    const div=document.createElement('div'); div.innerHTML=`<span class="font-bold" style="color:${color}">${m.user}</span> [${time}]: ${m.text}`;
    container.appendChild(div);
  });
  container.scrollTop=container.scrollHeight;
}
function sendMessage(){
  const input=document.getElementById('messageInput'); if(!input.value.trim()) return;
  const msg={user:currentUser,text:input.value,time:Date.now()};
  messages[currentServer][currentChannel].push(msg);
  renderMessages(); input.value='';
  servers[currentServer].messages=messages[currentServer]; saveServers();
}
function switchChannel(c){ currentChannel=c; renderMessages(); }

/*** DM SYSTEM ***/
function renderDMUsers(){
  const dm=document.getElementById('dm-users'); dm.innerHTML='';
  users.filter(u=>u.username!=currentUser).forEach(u=>{
    const div=document.createElement('div'); div.className='dm-user cursor-pointer'; div.textContent=u.username; div.onclick=()=>openDM(u.username); dm.appendChild(div);
  });
}
function openDM(username){
  const dmId="DM_"+[currentUser,username].sort().join("_");
  if(!servers[dmId]) servers[dmId]={name:username,channels:["general"],roles:{member:{color:"green",perm:["chat"]}},users:{[currentUser]:"member",[username]:"member"}};
  if(!messages[dmId]) messages[dmId]={general:[]};
  switchServer(dmId);
}

/*** POLLING FOR MULTIUSER SYNC ***/
function startPolling(){
  setInterval(async ()=>{
    await loadServers(); renderServers(); renderChannels(); renderDMUsers(); renderMessages();
  },2000);
}

/*** INIT UI ***/
function loadUI(){ renderServers(); renderChannels(); renderDMUsers(); renderMessages(); }

</script>
</body>
</html>
