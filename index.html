<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Puter + JSONBin Site Manager</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css" />
  <style>
    body{font-family:Inter,system-ui,Segoe UI,Arial;margin:0;height:100vh;display:flex;flex-direction:column}
    header{display:flex;gap:12px;align-items:center;padding:12px;background:#f7f8fb;border-bottom:1px solid #e6e9f2}
    header .title{font-weight:700}
    .btn{background:#0b84ff;color:#fff;padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
    main{display:flex;flex:1;gap:12px;padding:12px}
    .col{flex:1;display:flex;flex-direction:column;gap:8px}
    .frame-wrap{border:1px solid #e3e6ee;border-radius:8px;overflow:hidden;display:flex;flex-direction:column;height:100%}
    .frame-controls{display:flex;padding:8px;gap:8px;background:#fff;border-bottom:1px solid #eee}
    iframe{flex:1;border:0}
    .editor-wrap{border:1px solid #e3e6ee;border-radius:8px;overflow:hidden;display:flex;flex-direction:column;height:100%}
    .editor-controls{display:flex;gap:8px;padding:8px;background:#fff;border-bottom:1px solid #eee;align-items:center}
    .projects{display:flex;gap:8px;flex-wrap:wrap}
    .project-chip{background:#eef3ff;padding:6px 8px;border-radius:999px;font-size:13px;cursor:pointer}
    .chat{border-top:1px solid #eee;padding:8px;height:180px;overflow:auto;background:#fbfcff}
    .chat input{width:100%;box-sizing:border-box;padding:8px}
    .small{font-size:13px;color:#666}
    footer{padding:8px;text-align:center;font-size:13px;color:#777}
    #siteList a{display:block;margin:4px 0;color:#0b84ff;text-decoration:none}
  </style>
</head>
<body>
<header>
  <div class="title">Puter + JSONBin Site Manager</div>
  <button id="homeBtn" class="btn">Home (Browse)</button>
  <button id="createBtn" class="btn">Create New</button>
  <div style="margin-left:auto" class="small">Replace constants with your JSONBin keys.</div>
</header>

<main>
  <div class="col">
    <div class="frame-wrap">
      <div class="frame-controls">
        <input id="browseUrl" placeholder="https://example.com" style="flex:1;padding:8px;border:1px solid #ddd;border-radius:6px" />
        <button id="goBtn" class="btn">Go</button>
      </div>
      <iframe id="browserFrame" srcdoc="<h3 style='font-family:system-ui;padding:18px'>Welcome â€” choose a site below</h3><div id='siteList' style='padding:12px'></div>"></iframe>
    </div>

    <div style="margin-top:8px" class="editor-wrap">
      <div class="editor-controls">
        <div class="projects" id="projectList"></div>
        <div style="margin-left:auto;display:flex;gap:8px">
          <button id="loadBtn" class="btn">Load</button>
          <button id="saveBtn" class="btn">Save</button>
        </div>
      </div>
      <div id="editor" style="flex:1;height:320px"></div>
      <div class="chat" id="chatLog"></div>
      <div style="padding:8px;background:#fff;border-top:1px solid #eee;display:flex;gap:8px">
        <input id="chatInput" placeholder="Say something" />
        <button id="chatSend" class="btn">Send</button>
      </div>
    </div>
  </div>

  <div class="col" style="flex:0.6">
    <h3>Project Info</h3>
    <input id="projName" placeholder="Project name" />
    <input id="jsonbinId" placeholder="JSONBin ID" />
    <textarea id="projMeta" placeholder="Description" rows="4"></textarea>
    <div class="small">Each site gets its own JSONBin. A separate bin stores the directory list.</div>
    <footer>Docs: <a href="https://jsonbin.io" target="_blank">JSONBin</a>, <a href="https://developer.puter.com" target="_blank">Puter.js</a></footer>
  </div>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/htmlmixed/htmlmixed.min.js"></script>
<script>
const JSONBIN_API_KEY = "$2a$10$w7kHZII5PZ.x1MhtZTBQm.WFZP1ZkfvsbDscb/WNBo9.0kmDtxgH.";
const DIRECTORY_BIN_ID = "68cad7bd43b1c97be9463d0e"; // Stores list of sites

const editor = CodeMirror(document.getElementById("editor"), {value:"<!-- start coding -->",mode:"htmlmixed",lineNumbers:true});
let projects = JSON.parse(localStorage.getItem("pj_projects")||"{}");
let currentProjectId = null;

function saveLocal(){localStorage.setItem("pj_projects",JSON.stringify(projects));renderChips();}
function renderChips(){const list=document.getElementById("projectList");list.innerHTML="";Object.values(projects).forEach(p=>{let d=document.createElement("div");d.className="project-chip";d.textContent=p.name;d.onclick=()=>openProject(p.id);list.appendChild(d);});}

function createProject(name){let id="p"+Date.now();projects[id]={id,name,code:"<!-- empty -->",jsonbin:"",meta:"",chat:[]};currentProjectId=id;saveLocal();openProject(id);}
function openProject(id){currentProjectId=id;let p=projects[id];document.getElementById("projName").value=p.name;document.getElementById("jsonbinId").value=p.jsonbin;document.getElementById("projMeta").value=p.meta;editor.setValue(p.code);renderChat(p.chat);}
function renderChat(arr){const log=document.getElementById("chatLog");log.innerHTML="";(arr||[]).forEach(m=>{log.innerHTML+=`<div><strong>${m.who}</strong> <span class='small'>${new Date(m.t).toLocaleString()}</span><div>${m.text}</div></div>`});log.scrollTop=log.scrollHeight;}

document.getElementById("chatSend").onclick=()=>{if(!currentProjectId)return;let t=document.getElementById("chatInput").value.trim();if(!t)return;projects[currentProjectId].chat.push({who:"You",text:t,t:Date.now()});saveLocal();renderChat(projects[currentProjectId].chat);document.getElementById("chatInput").value="";};

document.getElementById("createBtn").onclick=()=>{let n=prompt("Project name?");if(n)createProject(n);}
document.getElementById("homeBtn").onclick=loadSiteList;
document.getElementById("goBtn").onclick=()=>{let u=document.getElementById("browseUrl").value;if(u)document.getElementById("browserFrame").src=u;}

document.getElementById("saveBtn").onclick=async()=>{
  if(!currentProjectId)return;
  let p=projects[currentProjectId];
  p.name=document.getElementById("projName").value; p.meta=document.getElementById("projMeta").value; p.code=editor.getValue();
  p.jsonbin=document.getElementById("jsonbinId").value;
  saveLocal();
  if(!p.jsonbin)return alert("Enter a JSONBin ID for this project");
  await fetch("https://api.jsonbin.io/v3/b/"+p.jsonbin,{method:"PUT",headers:{"Content-Type":"application/json","X-Master-Key":JSONBIN_API_KEY},body:JSON.stringify({name:p.name,meta:p.meta,code:p.code})});
  // Update directory
  if(DIRECTORY_BIN_ID){let dir=await fetch("https://api.jsonbin.io/v3/b/"+DIRECTORY_BIN_ID).then(r=>r.json());let arr=dir.record.sites||[];if(!arr.find(x=>x.jsonbin===p.jsonbin)){arr.push({name:p.name,jsonbin:p.jsonbin});}
    await fetch("https://api.jsonbin.io/v3/b/"+DIRECTORY_BIN_ID,{method:"PUT",headers:{"Content-Type":"application/json","X-Master-Key":JSONBIN_API_KEY},body:JSON.stringify({sites:arr})});}
  alert("Saved & directory updated!");
};

document.getElementById("loadBtn").onclick=async()=>{
  if(!currentProjectId)return;
  let id=document.getElementById("jsonbinId").value;if(!id)return;
  let j=await fetch("https://api.jsonbin.io/v3/b/"+id).then(r=>r.json());let rec=j.record||j.data;
  projects[currentProjectId].name=rec.name;projects[currentProjectId].meta=rec.meta;projects[currentProjectId].code=rec.code;saveLocal();openProject(currentProjectId);
};

async function loadSiteList(){
  if(!DIRECTORY_BIN_ID)return alert("Set DIRECTORY_BIN_ID");
  let j=await fetch("https://api.jsonbin.io/v3/b/"+DIRECTORY_BIN_ID).then(r=>r.json());let arr=j.record.sites||[];
  let html="<h3>Available Sites</h3>";arr.forEach(s=>{html+=`<a href='#' onclick='openRemoteSite("${s.jsonbin}")'>${s.name}</a>`});document.getElementById("browserFrame").srcdoc=html;
}

async function openRemoteSite(binId){
  let j=await fetch("https://api.jsonbin.io/v3/b/"+binId).then(r=>r.json());let rec=j.record||j.data;
  document.getElementById("browserFrame").srcdoc=rec.code;
}

if(Object.keys(projects).length===0)createProject("Demo");else renderChips();
</script>
</body>
</html>
