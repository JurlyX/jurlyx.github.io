<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PuterJS Web Host + IDE</title>
  <script src="https://js.puter.com/v2/"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@vscode/codicons/dist/codicon.css">
  <style>
    :root{
      --bg:#071025;
      --panel:#0f1724;
      --muted:#98a2b3;
      --accent:#60a5fa;
      --glass:rgba(255,255,255,0.03);
      --radius:12px;
      --mono:ui-monospace, SFMono-Regular, Menlo, Monaco, 'Roboto Mono', 'Courier New', monospace;
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#061022);color:#e6eef8;font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial}

    .layout{display:grid;grid-template-columns:280px 1fr 360px;gap:16px;padding:18px;height:100vh}
    @media (max-width:1100px){.layout{grid-template-columns:1fr;grid-auto-rows:min-content;padding:12px}}

    .panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:var(--radius);padding:14px;box-shadow:0 10px 30px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03)}

    .header{display:flex;align-items:center;gap:12px;margin-bottom:6px}
    .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(90deg,#2563eb,#7c3aed);display:flex;align-items:center;justify-content:center;font-weight:800}
    h1{font-size:15px;margin:0}
    .muted{color:var(--muted);font-size:13px}

    input[type=text],select,button{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:10px;border-radius:10px;color:inherit}
    button{cursor:pointer}
    button.primary{background:var(--accent);border:none;color:#04172b}

    .project-list{display:flex;flex-direction:column;gap:6px;overflow:auto;max-height:56vh;padding-right:6px}
    .project-item{padding:10px;border-radius:10px;cursor:pointer;border:1px solid transparent}
    .project-item:hover{background:rgba(255,255,255,0.02)}
    .project-item.active{background:linear-gradient(90deg, rgba(91,140,255,0.06), rgba(124,58,237,0.03));border-color:rgba(255,255,255,0.02)}

    .editor-top{display:flex;gap:8px;align-items:center;margin-bottom:10px}
    .editor-area{display:flex;gap:12px;height:68vh;min-height:420px}
    @media (max-width:1100px){.editor-area{flex-direction:column;height:auto}}

    .pane{flex:1;display:flex;flex-direction:column;gap:8px}
    .filebar{display:flex;gap:8px;align-items:center}

    .editor{flex:1;min-height:0;border-radius:10px;overflow:hidden;border:1px solid rgba(255,255,255,0.03);display:flex}
    textarea#editor{flex:1;border:none;padding:14px;font-family:var(--mono);font-size:13px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);color:inherit;outline:none;resize:none}

    .preview{flex:1;border-radius:10px;border:1px solid rgba(255,255,255,0.03);overflow:hidden}
    iframe#preview{width:100%;height:100%;border:0;background:white}

    .ai-header{display:flex;justify-content:space-between;align-items:center}
    .chat{display:flex;flex-direction:column;gap:8px;height:68vh;min-height:420px}
    .chat-log{flex:1;overflow:auto;padding:8px;border-radius:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00))}
    .msg{max-width:80%;padding:10px;border-radius:10px;margin:6px 0}
    .msg.user{margin-left:auto;background:linear-gradient(90deg,#6ea8ff,#7c3aed);color:#041027}
    .msg.assistant{background:rgba(255,255,255,0.02)}

    .console{height:140px;padding:8px;border-radius:8px;background:rgba(0,0,0,0.25);font-family:var(--mono);font-size:13px;overflow:auto}

    .small{font-size:12px;color:var(--muted)}
    a.link{color:var(--accent);text-decoration:none}
  </style>
</head>
<body>
  <div class="layout">
    <!-- Sidebar -->
    <div class="panel">
      <div class="header">
        <div class="logo">PJ</div>
        <div>
          <div style="font-weight:600">Puter Host</div>
          <div style="font-size:12px;color:var(--muted)">Projects</div>
        </div>
      </div>
      <button id="newProject">New Project</button>
      <input id="projectName" placeholder="Project name"/>
      <div class="files" id="projects"></div>
      <button id="saveCloud">Save to Puter</button>
      <button id="publish" class="primary">Publish</button>
      <div style="font-size:12px;color:var(--muted)">Host URL: <span id="hostUrl">—</span></div>
    </div>

    <!-- Editor -->
    <div class="panel editor-panel">
      <div style="display:flex;gap:8px;align-items:center">
        <select id="fileSelect"></select>
        <button id="newFile">+ File</button>
        <button id="deleteFile">Delete</button>
        <button id="refresh">Refresh Preview</button>
      </div>
      <div class="editor-area">
        <textarea id="editor"></textarea>
        <iframe id="preview"></iframe>
      </div>
    </div>

    <!-- Assistant -->
    <div class="panel">
      <div class="header">
        <span style="font-weight:600">AI Assistant</span>
      </div>
      <div class="chat">
        <div id="chatLog" class="chat-log"></div>
        <div style="display:flex;gap:8px">
          <input id="prompt" placeholder="Ask AI..."/>
          <button id="ask">Ask</button>
        </div>
        <div class="console" id="console"></div>
      </div>
    </div>
  </div>

<script>
const DEFAULT_FILES={"index.html":"<!doctype html><html><head><meta charset='utf-8'><title>New Site</title><link rel='stylesheet' href='/style.css'></head><body><h1>Hello</h1><script src='/script.js'></script></body></html>","style.css":"body{font-family:sans-serif;text-align:center;padding-top:20vh}" ,"script.js":"console.log('Hello from JS')"};
let projects=JSON.parse(localStorage.getItem('pj_projects')||'{}');
let current=null;
const editor=document.getElementById('editor');
const fileSelect=document.getElementById('fileSelect');
const preview=document.getElementById('preview');
const log=(msg)=>{const c=document.getElementById('console');c.textContent+=msg+"\n";c.scrollTop=c.scrollHeight;};

function renderProjects(){const el=document.getElementById('projects');el.innerHTML='';for(const name of Object.keys(projects)){const d=document.createElement('div');d.textContent=name;d.className='file-item'+(current===name?' active':'');d.onclick=()=>loadProject(name);el.appendChild(d)}}
function newProject(name){if(!name)name='proj-'+Math.random().toString(36).slice(2,7);projects[name]=JSON.parse(JSON.stringify(DEFAULT_FILES));saveLocal();renderProjects();loadProject(name)}
function loadProject(name){current=name;document.getElementById('projectName').value=name;updateFileSelect();fileSelect.value='index.html';editor.value=projects[name]['index.html'];updatePreview();renderProjects()}
function saveLocal(){if(current){projects[current][fileSelect.value]=editor.value;localStorage.setItem('pj_projects',JSON.stringify(projects));log('Saved '+current)}}
function updateFileSelect(){fileSelect.innerHTML='';for(const f of Object.keys(projects[current])){const o=document.createElement('option');o.value=f;o.textContent=f;fileSelect.appendChild(o)}}
function buildPreview(files){let html=files['index.html']||'';html=html.replace(/<link rel='stylesheet' href='\/(.*?)'>/g,(m,p1)=>`<style>${files[p1]||''}</style>`).replace(/<script src='\/(.*?)'><\\/script>/g,(m,p1)=>`<script>${files[p1]||''}<\\/script>`);return html}
function updatePreview(){if(!current)return;preview.srcdoc=buildPreview(projects[current])}

// Events
document.getElementById('newProject').onclick=()=>newProject();
fileSelect.onchange=()=>editor.value=projects[current][fileSelect.value]||'';
editor.oninput=()=>{projects[current][fileSelect.value]=editor.value};
document.getElementById('newFile').onclick=()=>{const fn=prompt('File name?');if(fn){projects[current][fn]='';updateFileSelect();fileSelect.value=fn;editor.value=''}};
document.getElementById('deleteFile').onclick=()=>{const f=fileSelect.value;if(confirm('Delete '+f+'?')){delete projects[current][f];updateFileSelect();editor.value=projects[current][fileSelect.value]||''}};
document.getElementById('refresh').onclick=updatePreview;

// Save to cloud
document.getElementById('saveCloud').onclick=async()=>{try{await puter.auth.signIn();const dir='/projects/'+current;await puter.fs.mkdir(dir).catch(()=>{});for(const [f,c] of Object.entries(projects[current]))await puter.fs.write(dir+'/'+f,c);log('Saved to Puter cloud')}catch(e){log('Cloud save error: '+e.message)}}

// Publish
document.getElementById('publish').onclick=async()=>{try{await puter.auth.signIn();const dir='/projects/'+current;await puter.fs.mkdir(dir).catch(()=>{});for(const [f,c] of Object.entries(projects[current]))await puter.fs.write(dir+'/'+f,c);const sub=current.toLowerCase().replace(/[^a-z0-9-]/g,'-').slice(0,20)+'-'+Math.random().toString(36).slice(2,6);const site=await puter.hosting.create(sub,dir);const url='https://'+site.subdomain+'.puter.site';document.getElementById('hostUrl').innerHTML='<a href="'+url+'" target="_blank">'+url+'</a>';log('Published: '+url)}catch(e){log('Publish error: '+e.message)}}

// AI assistant
document.getElementById('ask').onclick=async()=>{const q=document.getElementById('prompt').value.trim();if(!q)return;document.getElementById('prompt').value='';const user=document.createElement('div');user.className='msg user';user.textContent=q;chatLog.appendChild(user);chatLog.scrollTop=chatLog.scrollHeight;const ai=document.createElement('div');ai.className='msg assistant';ai.textContent='…';chatLog.appendChild(ai);try{const context=Object.entries(projects[current]||{}).map(([k,v])=>`FILE:${k}\n${v}`).join('\n');const res=await puter.ai.chat({model:'gpt-5-nano',messages:[{role:'user',content:`User request: ${q}\nFiles:\n${context}`} ]});const text=res.choices?.[0]?.message?.content||'';ai.textContent=text;try{const parsed=JSON.parse(text);if(parsed.file&&parsed.content!==undefined){projects[current][parsed.file]=parsed.content;if(fileSelect.value===parsed.file)editor.value=parsed.content;updatePreview();log('Patched '+parsed.file)}}catch{}}catch(e){ai.textContent='Error: '+e.message}}

// Init
if(Object.keys(projects).length===0)newProject('demo');else{renderProjects();loadProject(Object.keys(projects)[0])}
setInterval(saveLocal,4000);
</script>
</body>
</html>
