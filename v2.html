<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PuterJS — Elegant Host & IDE</title>
  <script src="https://js.puter.com/v2/"></script>
  <style>
    :root {
      --bg-primary: #0f111b;
      --bg-panel: #1a1d2e;
      --text-main: #e0e6ed;
      --text-muted: #7a8c99;
      --accent: #5799eb;
      --border: #2c3142;
      --radius: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, 'Roboto Mono', 'Courier New', monospace;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    html, body {
      height: 100%;
      font-family: 'Inter', system-ui, sans-serif;
      background: var(--bg-primary);
      color: var(--text-main);
      line-height: 1.5;
    }

    a { color: var(--accent); text-decoration: none; }

    .layout {
      display: grid;
      grid-template-columns: 300px 1fr 320px;
      gap: 20px;
      padding: 30px;
      height: 100vh;
    }
    @media (max-width: 1200px) {
      .layout { grid-template-columns: 1fr; grid-auto-rows: min-content; padding: 20px; }
    }

    .panel {
      background: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.5);
      display: flex;
      flex-direction: column;
    }

    .header {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 20px;
    }
    .logo {
      width: 48px;
      height: 48px;
      border-radius: var(--radius);
      background: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 24px;
      color: #fff;
    }
    h1 {
      font-size: 20px;
      color: var(--text-main);
    }
    .muted {
      color: var(--text-muted);
      font-size: 14px;
    }

    input[type=text], select, button, textarea {
      background: var(--bg-primary);
      color: var(--text-main);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 10px 14px;
      font-size: 14px;
      font-family: inherit;
    }
    input[type=text]::placeholder, textarea::placeholder {
      color: var(--text-muted);
    }
    button {
      cursor: pointer;
      transition: background-color 0.15s, border-color 0.15s;
    }
    button.primary {
      background: var(--accent);
      color: #fff;
      border: none;
    }
    button:hover {
      background-color: rgba(87, 153, 235, 0.8);
    }
    button.primary:hover {
      background-color: #4c8bd1;
    }

    .project-list {
      margin-top: 16px;
      flex: 1;
      overflow-y: auto;
    }
    .project-item {
      padding: 12px 16px;
      border-radius: var(--radius);
      border: 1px solid transparent;
      margin-bottom: 8px;
      transition: background-color 0.2s, border-color 0.2s;
    }
    .project-item:hover {
      background-color: #2d324d;
    }
    .project-item.active {
      border-color: var(--accent);
      background-color: #22304d;
    }

    .editor-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }
    .editor-area {
      display: flex;
      gap: 20px;
      height: 70vh;
      min-height: 450px;
    }
    @media (max-width: 1200px) {
      .editor-area { flex-direction: column; height: auto; }
    }

    .pane {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .filebar {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    textarea#editor {
      flex: 1;
      padding: 16px;
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-family: var(--mono);
      font-size: 14px;
      color: var(--text-main);
      resize: none;
      outline: none;
    }

    .preview {
      flex: 1;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      background: #fff;
    }
    iframe#preview {
      width: 100%;
      height: 100%;
      border: none;
    }

    .chat {
      display: flex;
      flex-direction: column;
      gap: 12px;
      height: 70vh;
      min-height: 450px;
    }
    .chat-log {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      background: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
    }
    .msg {
      max-width: 80%;
      padding: 12px;
      border-radius: var(--radius);
      margin-bottom: 8px;
      line-height: 1.4;
    }
    .msg.user {
      align-self: flex-end;
      background: var(--accent);
      color: #fff;
    }
    .msg.assistant {
      align-self: flex-start;
      background: #2a2f44;
      color: var(--text-main);
    }

    .console {
      height: 150px;
      background: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px;
      font-family: var(--mono);
      font-size: 13px;
      overflow-y: auto;
      color: var(--text-main);
    }

    .small {
      font-size: 13px;
      color: var(--text-muted);
    }

  </style>
</head>
<body>
  <div class="layout">
    <!-- Left panel: Projects -->
    <div class="panel">
      <div class="header">
        <div class="logo">PJ</div>
        <div>
          <h1>PuterJS Host</h1>
          <div class="muted">Create · Edit · Publish</div>
        </div>
      </div>
      <input id="projectName" type="text" placeholder="Project name…" />
      <div style="margin-top:12px; display:flex; gap:8px;">
        <button id="newProject">New Project</button>
        <button id="saveLocal" class="primary">Save</button>
      </div>
      <div class="project-list" id="projects"></div>
      <div style="margin-top:auto; display:flex; gap:10px; justify-content:flex-start; align-items:center;">
        <button id="signIn">Sign in</button>
        <button id="syncCloud">Sync</button>
        <button id="publish" class="primary">Publish</button>
      </div>
      <div style="margin-top:12px;" class="small">Published at <span id="hostUrl">(not published)</span></div>
    </div>

    <!-- Center panel: Editor & Preview -->
    <div class="panel">
      <div class="editor-top">
        <div>
          <div style="font-weight:bold;">Editor</div>
          <div class="muted">Edit files, live preview inline</div>
        </div>
        <div class="small">Autosave every 5s · Ctrl/Cmd+S</div>
      </div>
      <div class="editor-area">
        <div class="pane">
          <div class="filebar">
            <select id="fileSelect"></select>
            <button id="newFile">+ File</button>
            <button id="deleteFile">Delete</button>
          </div>
          <textarea id="editor" spellcheck="false">// Your code here…</textarea>
        </div>
        <div class="pane preview">
          <div style="margin-bottom:10px; display:flex; justify-content:flex-end;">
            <button id="refresh">Refresh Preview</button>
          </div>
          <iframe id="preview" sandbox="allow-scripts allow-forms allow-modals"></iframe>
        </div>
      </div>
      <div style="margin-top:16px; display:flex; gap:8px; justify-content:flex-end; align-items:center;">
        <div class="small">Share: <input id="shareToken" placeholder="?site=…" style="width:240px;" /></div>
        <button id="shareBtn">Share</button>
      </div>
    </div>

    <!-- Right panel: AI Assistant & Console -->
    <div class="panel">
      <div class="header">
        <div style="font-weight:bold;">Assistant</div>
        <div class="muted">Safe code patches</div>
      </div>
      <div class="chat">
        <div id="chatLog" class="chat-log"></div>
        <div style="display:flex; gap:8px; align-items:center;">
          <input id="prompt" placeholder="Ask the assistant…" />
          <button id="ask" class="primary">Ask</button>
        </div>
        <div style="margin-top:12px;" class="small">Console</div>
        <pre id="console" class="console"></pre>
      </div>
    </div>
  </div>

  <script>
    // Clean storage if corrupted
    try {
      const test = localStorage.getItem('pj_projects');
      if (test && /^[\\{\\[]/.test(test) === false) {
        localStorage.removeItem('pj_projects');
      }
    } catch(e) {
      localStorage.removeItem('pj_projects');
    }

    const DEFAULT_FILES = {
      'index.html': `<!DOCTYPE html>
<html lang="en">
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>PuterJS Site</title><link rel="stylesheet" href="/style.css"></head>
<body><main><h1>Welcome to Puter Host</h1><p>Your editable code starts here.</p></main><script src="/script.js"></script></body>
</html>`,
      'style.css': `body { margin:0; padding:40px; background:#1a1d2e; color:#e0e6ed; font-family:system-ui, sans-serif; } main { max-width:640px; margin:0 auto; text-align:center; }`,
      'script.js': `console.log('Hello from PuterJS');`
    };

    let projects = JSON.parse(localStorage.getItem('pj_projects') || '{}');
    let current = null;

    // DOM refs
    const projectsEl = document.getElementById('projects');
    const projectNameEl = document.getElementById('projectName');
    const fileSelect = document.getElementById('fileSelect');
    const editorEl = document.getElementById('editor');
    const previewEl = document.getElementById('preview');
    const chatLog = document.getElementById('chatLog');
    const consoleEl = document.getElementById('console');

    function log(msg) {
      consoleEl.textContent += msg + '\\n';
      consoleEl.scrollTop = consoleEl.scrollHeight;
    }

    function renderProjects() {
      projectsEl.innerHTML = '';
      for (const name of Object.keys(projects)) {
        const d = document.createElement('div');
        d.className = 'project-item' + (name === current ? ' active' : '');
        d.textContent = name;
        d.addEventListener('click', ()=> loadProject(name));
        projectsEl.appendChild(d);
      }
    }

    function newProject(name) {
      if (!name) name = 'proj-' + Math.random().toString(36).slice(2,7);
      projects[name] = JSON.parse(JSON.stringify(DEFAULT_FILES));
      saveLocal();
      renderProjects();
      loadProject(name);
    }

    function loadProject(name) {
      current = name;
      projectNameEl.value = name;
      populateFileSelect();
      fileSelect.value = 'index.html';
      editorEl.value = projects[name]['index.html'];
      renderProjects();
      updatePreview();
    }

    function populateFileSelect() {
      fileSelect.innerHTML = '';
      const files = projects[current] || {};
      for (const f in files) {
        const opt = document.createElement('option');
        opt.value = f;
        opt.textContent = f;
        fileSelect.appendChild(opt);
      }
    }

    function saveLocal() {
      if (!current) return;
      projects[current][fileSelect.value] = editorEl.value;
      localStorage.setItem('pj_projects', JSON.stringify(projects));
      log('Saved ' + current);
    }

    editorEl.addEventListener('input', ()=>{
      if (current) projects[current][fileSelect.value] = editorEl.value;
    });

    document.getElementById('newProject').addEventListener('click', ()=> newProject());
    document.getElementById('saveLocal').addEventListener('click', saveLocal);
    fileSelect.addEventListener('change', (e)=> editorEl.value = projects[current][e.target.value] || '');

    document.getElementById('newFile').addEventListener('click', ()=>{
      const fname = prompt('New file name: ');
      if (!fname) return;
      projects[current][fname] = '';
      populateFileSelect();
      fileSelect.value = fname;
      editorEl.value = '';
      saveLocal();
    });

    document.getElementById('deleteFile').addEventListener('click', ()=>{
      const f = fileSelect.value;
      if (!f) return;
      if (!confirm('Delete '+f+'?')) return;
      delete projects[current][f];
      populateFileSelect();
      fileSelect.selectedIndex = 0;
      editorEl.value = projects[current][fileSelect.value] || '';
      saveLocal();
    });

    document.getElementById('refresh').addEventListener('click', updatePreview);

    function buildPreviewHtml(files) {
      let html = files['index.html'] || '';
      html = html.replace(/<link\\s+rel=(?:\"|')stylesheet(?:\"|')\\s+href=(?:\"|')\\/(.*?)(?:\"|')>/gi, (m,p1)=>{
        const css = files[p1] || '';
        return `<style>/* inlined: ${p1} */\\n${css}</style>`;
      });
      html = html.replace(/<script\\s+src=(?:\"|')\\/(.*?)(?:\"|')><\\/script>/gi, (m,p1)=>{
        const js = files[p1] || '';
        return `<script>/* inlined: ${p1} */\\n${js}</script>`;
      });
      return html;
    }

    function updatePreview(){
      if (!current) return;
      try {
        previewEl.srcdoc = buildPreviewHtml(projects[current]);
      } catch(e) {
        log('Preview error: ' + e.message);
      }
    }

    // init
    if (Object.keys(projects).length === 0) {
      newProject('welcome-project');
    } else {
      renderProjects();
      const first = Object.keys(projects)[0];
      loadProject(first);
    }

    setInterval(saveLocal, 5000);

    window.addEventListener('keydown', (e)=>{
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') {
        e.preventDefault();
        saveLocal();
        alert('Saved');
      }
    });
  </script>
</body>
</html>
